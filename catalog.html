<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>catalogue d’enquêtes de type OSINT</title>
<style>
:root{--bg:#fff;--fg:#0f172a;--muted:#475569;--card:#ffffff;--border:#e2e8f0;--chip:#f1f5f9;--chip-fg:#334155;--emerald:#059669;--amber:#d97706;--indigo:#4f46e5}
*{box-sizing:border-box}html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
.container{max-width:1120px;margin:0 auto;padding:0 16px}
.header{background:linear-gradient(90deg,#6ee7b7,#34d399,#2dd4bf);padding:40px 0}
.h1{margin:0;font-weight:800;font-size:28px}
.sub{opacity:.85;font-size:18px;margin-top:6px}
.grid{display:grid;grid-template-columns:1fr;gap:16px}
@media(min-width:768px){.grid{grid-template-columns:1fr 1fr}}
@media(min-width:1200px){.grid{grid-template-columns:1fr 1fr 1fr}}
.card{background:var(--card);border:1px solid var(--border);border-left:8px solid transparent;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);overflow:hidden}
.card .body{padding:16px}
.flex{display:flex}.items-start{align-items:flex-start}.gap-3{gap:12px}.mb-2{margin-bottom:8px}.mb-3{margin-bottom:12px}
.logo{width:40px;height:40px;object-fit:contain;border-radius:4px;background:#fff}
.title{font-weight:700;font-size:18px;margin:0;line-height:1.25}
.p{font-size:14px;color:#334155;margin:0}
.row{display:flex;align-items:center;justify-content:space-between;font-size:14px;color:#475569}
.badges,.authors{display:flex;flex-wrap:wrap;gap:8px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
.badge-gray{background:var(--chip);color:var(--chip-fg)}
.badge-ia{background:var(--indigo);color:#fff}
.badge-pro{background:var(--emerald);color:#fff}
.badge-rea{background:var(--amber);color:#fff}
.controls{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:768px){.controls{grid-template-columns:1fr 1fr}}
@media(min-width:1200px){.controls{grid-template-columns:1fr 1fr 1fr}}
.label{font-size:13px;color:#334155;margin-bottom:4px}
.input,.select,.date{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:8px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
.btn.primary{background:#059669;color:#fff;border-color:#059669}
.counter{font-size:14px;color:#475569;margin:8px 0 12px}
.footer{border-top:1px solid var(--border);margin-top:28px}
.footer .inner{padding:16px 0;color:#475569;font-size:14px}
.error{display:none;margin:0 0 12px;padding:10px;border-radius:10px;background:#fef2f2;color:#b91c1c;font-size:14px}
.drop{display:none;border:2px dashed #94a3b8;border-radius:12px;padding:16px;text-align:center;color:#334155;background:#f8fafc}
.drop.show{display:block}
</style>
</head>
<body>
  <header class="header">
    <div class="container">
      <h1 class="h1">catalogue d’enquêtes de type OSINT</h1>
      <p class="sub">Investigations audiovisuelles</p>
    </div>
  </header>

  <main class="container" style="padding:24px 0">
    <div id="err" class="error"></div>

    <section class="controls" aria-labelledby="filters">
      <div>
        <div class="label">Recherche (titre, résumé, commentaire)</div>
        <input id="q" type="search" placeholder="Rechercher..." class="input"/>
      </div>
      <div>
        <div class="label">Média</div>
        <select id="f-media" class="select"></select>
      </div>
      <div>
        <div class="label">Auteurs</div>
        <select id="f-authors" class="select"></select>
      </div>
      <div>
        <div class="label">Proactivité</div>
        <select id="f-proact" class="select">
          <option value="">(toutes)</option>
          <option value="proactive">proactive</option>
          <option value="reactive">reactive</option>
        </select>
      </div>
      <div>
        <div class="label">IA</div>
        <select id="f-ia" class="select">
          <option value="">(tout)</option>
          <option value="yes">yes</option>
          <option value="no">no</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;align-items:end">
        <button id="btn-reset" class="btn">Réinitialiser</button>
        <button id="btn-export" class="btn primary">Exporter en CSV</button>
        <input id="file" type="file" accept="application/json,.json" style="display:none"/>
        <button id="btn-import" class="btn" title="Importer data_osint.json si la page est ouverte en file://">Importer JSON</button>
      </div>
    </section>

    <div id="drop" class="drop">Glissez-déposez votre <strong>data_osint.json</strong> ici</div>

    <div id="counter" class="counter"></div>

    <section>
      <div id="results" class="grid"></div>
    </section>
  </main>

  <footer class="footer">
    <div class="container inner">
      Projet MatrioscIA. Olivier Le Deuff, Thais Barbosa de Almeida, Rayya Roumanos, Mailuxa Pagola. 2025. Licence CC BY
    </div>
  </footer>

<!-- OPTIONNEL : si tu veux éviter tout fetch, colle ici ton JSON complet
<script id="osint-data" type="application/json">[ { "title":"...", "content":"...", ... } ]</script>
-->

<script>
/* === Chargement “failsafe” du JSON ===================================== */
(async function init(){
  const els = getEls();
  const state = { data: [], filtered: [] };

  // 1) Essayer un JSON inline (script#osint-data)
  const inline = document.getElementById('osint-data');
  if (inline && inline.textContent.trim().startsWith('[')) {
    try {
      state.data = JSON.parse(inline.textContent);
      boot(state);
      return;
    } catch(e) { showErr('JSON inline invalide : '+e.message); }
  }

  // 2) Si http(s), tenter fetch('./data_osint.json')
  if (location.protocol.startsWith('http')) {
    try {
      const r = await fetch('./data_osint.json', {cache:'no-store'});
      if (!r.ok) throw new Error(r.status+' '+r.statusText);
      state.data = await r.json();
      boot(state);
      return;
    } catch(e) {
      showErr('Impossible de charger data_osint.json : '+e.message);
      showImporter(els, state);
    }
  } else {
    // 3) file:// → proposer Importer (FileReader) + glisser-déposer
    showErr('Ouverture locale détectée (file://). Utilise “Importer JSON”.');
    showImporter(els, state);
  }
})();

function getEls(){
  return {
    q: document.getElementById('q'),
    media: document.getElementById('f-media'),
    authors: document.getElementById('f-authors'),
    pro: document.getElementById('f-proact'),
    ia: document.getElementById('f-ia'),
    reset: document.getElementById('btn-reset'),
    exportBtn: document.getElementById('btn-export'),
    importBtn: document.getElementById('btn-import'),
    file: document.getElementById('file'),
    drop: document.getElementById('drop'),
    counter: document.getElementById('counter'),
    results: document.getElementById('results'),
    err: document.getElementById('err'),
  };
}

function showErr(msg){
  const e=document.getElementById('err');
  e.textContent=msg;
  e.style.display='block';
}

function showImporter(els, state){
  els.importBtn.addEventListener('click', ()=> els.file.click());
  els.file.addEventListener('change', ev=>{
    const f=ev.target.files?.[0];
    if(!f) return;
    const fr=new FileReader();
    fr.onload = () => {
      try {
        const json = JSON.parse(String(fr.result||'[]'));
        state.data = json;
        document.getElementById('err').style.display='none';
        boot(state);
      } catch(e){ showErr('JSON illisible : '+e.message); }
    };
    fr.readAsText(f);
  });
  // drag & drop
  const dz = els.drop;
  dz.classList.add('show');
  ;['dragenter','dragover'].forEach(ev=>document.addEventListener(ev, e=>{e.preventDefault(); dz.style.borderColor='#16a34a'}));
  ;['dragleave','drop'].forEach(ev=>document.addEventListener(ev, e=>{e.preventDefault(); dz.style.borderColor='#94a3b8'}));
  document.addEventListener('drop', e=>{
    const f=e.dataTransfer?.files?.[0];
    if(!f) return;
    const fr=new FileReader();
    fr.onload = () => {
      try {
        const json = JSON.parse(String(fr.result||'[]'));
        state.data = json;
        document.getElementById('err').style.display='none';
        dz.classList.remove('show');
        boot(state);
      } catch(err){ showErr('JSON illisible : '+err.message); }
    };
    fr.readAsText(f);
  });
}

function boot(state){
  // Normaliser (auteurs, proactivité, IA)
  state.data = (state.data||[]).map((r,i)=>({
    title: r.title||r.Titre||'(sans titre)',
    content: r.content||r.presentation||r.Résumé||'',
    date: r.date||r.begin||'',
    media: (r.media||r['Lieu de publication']||'').toString().trim(),
    link: Array.isArray(r.links)? (r.links[0]||'') : (r.link||r.links||''),
    commentaire: r.commentaire||'',
    authors: Array.isArray(r.authors)? r.authors : splitAuthors(r.authors||r.auteurs||''),
    theme: r.theme||r.thématique||r['thématique']||'',
    proact: normPro(r.proact||r.proactivité||r['proactivité']),
    hasIA: normIAflag(r.hasIA, r.commentaire, r.title, r.content),
    _id: i
  }));

  buildFilters(state.data);
  attachHandlers(state);
  render(state);
}

function splitAuthors(s){
  return String(s||'').split(/\s*(?:\||,|;|\/|\bet\b|&)\s*/i).filter(Boolean);
}
function normPro(v){
  const s=String(v||'').toLowerCase();
  if (s.includes('proact')) return 'proactive';
  if (s.includes('réact') || s.includes('react')) return 'reactive';
  return '';
}
function normIAflag(flag, ...texts){
  // si le champ explicite est fourni
  const f = String(flag||'').toLowerCase();
  if (['y','yes','oui','true','1'].includes(f)) return true;
  if (['n','no','non','false','0'].includes(f)) return false;
  // sinon heuristique textes
  const hay = (texts||[]).join(' ').normalize('NFD').toLowerCase();
  return /intelligence artificielle|\bia\b|i\.a\.|\bai\b|\bllm\b|deepfake|apprentissage automatique|deep ?learning|réseau neuronal|reseau neuronal|mod(?:e|è)le de langue|g(?:e|é)n(?:e|é)ratif|chatgpt|openai|midjourney|stable diffusion|\bllama\b|elevenlabs|\bsuno\b/.test(hay);
}

function buildFilters(rows){
  const medias = [...new Set(rows.map(r=>r.media).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'}));
  const authors = [...new Set(rows.flatMap(r=>r.authors||[]))].sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'}));
  document.getElementById('f-media').innerHTML = '<option value="">(tous)</option>'+medias.map(v=>`<option>${escape(v)}</option>`).join('');
  document.getElementById('f-authors').innerHTML = '<option value="">(tous)</option>'+authors.map(v=>`<option>${escape(v)}</option>`).join('');
}

function attachHandlers(state){
  ['q','f-media','f-authors','f-proact','f-ia'].forEach(id=>{
    const el=document.getElementById(id);
    el.addEventListener('input', ()=>render(state));
    el.addEventListener('change', ()=>render(state));
  });
  document.getElementById('btn-reset').addEventListener('click', ()=>{
    ['q','f-media','f-authors','f-proact','f-ia'].forEach(id=>{document.getElementById(id).value=''});
    render(state);
  });
  document.getElementById('btn-export').addEventListener('click', ()=>exportCSV(state.filtered||[]));
}

function render(state){
  const q = document.getElementById('q').value.trim().toLowerCase();
  const fm = document.getElementById('f-media').value;
  const fa = document.getElementById('f-authors').value;
  const fp = document.getElementById('f-proact').value;
  const fia= document.getElementById('f-ia').value;

  const rows = state.data.filter(r=>{
    if (q){
      const hay = (r.title+' '+r.content+' '+r.commentaire).toLowerCase();
      if (!hay.includes(q)) return false;
    }
    if (fm && r.media!==fm) return false;
    if (fa && !(r.authors||[]).includes(fa)) return false;
    if (fp && (r.proact||'')!==fp) return false;
    if (fia==='yes' && !r.hasIA) return false;
    if (fia==='no' && r.hasIA) return false;
    return true;
  });

  rows.sort((a,b)=>{
    const da=a.date||'', db=b.date||'';
    if (da===db) return a.title.localeCompare(b.title,'fr',{sensitivity:'base'});
    return da<db ? 1 : -1;
  });

  state.filtered = rows;
  document.getElementById('counter').textContent = `${rows.length} résultat(s) affiché(s) / ${state.data.length}`;

  const html = rows.map(rec=>{
    const pro = rec.proact==='proactive' ? '<span class="badge badge-pro">proactive</span>' : (rec.proact==='reactive' ? '<span class="badge badge-rea">reactive</span>' : '');
    const ia  = rec.hasIA ? '<span class="badge badge-ia">IA</span>' : '';
    const med = rec.media ? `<span class="badge badge-gray">${escape(rec.media)}</span>` : '';
    const authors = (rec.authors||[]).map(a=>`<span class="badge badge-gray">${escape(a)}</span>`).join(' ');
    const link = rec.link ? `<a href="${escapeAttr(rec.link)}" class="ml-2" target="_blank" rel="noopener" title="Ouvrir le lien">🔗</a>` : '';
    return `
<article class="card" style="border-left-color:#94a3b8">
  <div class="body">
    <div class="flex items-start gap-3 mb-2"><div class="logo" aria-hidden="true"></div><h3 class="title">${escape(rec.title)}</h3></div>
    <p class="p mb-3">${escape(rec.content||'')}</p>
    <div class="badges mb-3">${med} ${ia} ${pro}</div>
    ${authors?`<div class="authors mb-3">${authors}</div>`:''}
    <div class="row"><time>${escape(rec.date || '(date manquante)')}</time>${link}</div>
  </div>
</article>`;
  }).join('');

  document.getElementById('results').innerHTML = html || '<div class="card"><div class="body">Aucun résultat.</div></div>';
}

function exportCSV(rows){
  const headers=["title","content","date","media","link","commentaire","authors","theme","proact","hasIA"];
  const esc=v=>('"'+String(v).replace(/"/g,'""')+'"');
  const lines=[headers.join(',')];
  rows.forEach(r=>{
    lines.push([
      esc(r.title||''), esc((r.content||'').replace(/\r?\n/g,' ')), esc(r.date||''), esc(r.media||''),
      esc(r.link||''), esc((r.commentaire||'').replace(/\r?\n/g,' ')), esc((r.authors||[]).join(' | ')),
      esc(r.theme||''), esc(r.proact||''), esc(r.hasIA?'yes':'no')
    ].join(','));
  });
  const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='export_filtre.csv';document.body.appendChild(a);a.click();URL.revokeObjectURL(url);a.remove();
}

function escape(s=''){return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
function escapeAttr(s=''){return s.replace(/"/g,'&quot;');}
</script>
</body>
</html>
