<!DOCTYPE html>
<html lang="fr" data-theme="auto">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bibliographie ‚Äî MatrioscIA</title>
<style>
  :root { --bg:#fff; --card:#f8fafc; --muted:#475569; --text:#0f172a; --border:#e2e8f0; --accent:#0ea5e9; --accent-2:#22c55e; --warn:#f97316; --chip:#eef2f7; --chip-border:#cbd5e1; --shadow:0 1px 2px rgba(0,0,0,.05), 0 8px 24px rgba(0,0,0,.06); }
  [data-theme="dark"] { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --border:#1f2937; --accent:#38bdf8; --accent-2:#4ade80; --warn:#fb923c; --chip:#1f2937; --chip-border:#334155; --shadow:0 1px 2px rgba(0,0,0,.25), 0 8px 24px rgba(0,0,0,.3); }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial}
  header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:rgba(255,255,255,.75);border-bottom:1px solid var(--border)}[data-theme="dark"] header{background:rgba(15,23,42,.75)}
  .wrap{max-width:1200px;margin:0 auto;padding:1rem}.top{display:flex;align-items:center;gap:.8rem;justify-content:space-between}.title{font-size:clamp(1.1rem,2.2vw,1.6rem);font-weight:700}.sub{color:var(--muted);font-size:.95rem}
  .toolbar{display:grid;grid-template-columns:1fr 160px 180px 220px;gap:.6rem;margin-top:.75rem}
  input[type="search"],select{width:100%;padding:.7rem .8rem;background:var(--bg);border:1px solid var(--border);border-radius:.6rem;color:var(--text);box-shadow:var(--shadow)}
  main{display:grid;grid-template-columns:320px 1fr;gap:1rem;margin-top:1rem}aside{position:sticky;top:110px;align-self:start;display:flex;flex-direction:column;gap:1rem}
  .panel{background:var(--card);border:1px solid var(--border);border-radius:.8rem;padding:.8rem;box-shadow:var(--shadow)}.panel h3{margin:.2rem 0 .6rem;font-size:1rem}
  .list{display:grid;gap:.75rem}.item{background:var(--card);border:1px solid var(--border);border-radius:.8rem;padding:.9rem;box-shadow:var(--shadow);border-left:4px solid transparent}
  .item.journal{border-left-color:var(--accent-2)}.item.newspaper{border-left-color:var(--warn)}.item h4{margin:.1rem 0 .4rem;font-size:1.02rem}.apa{margin:.3rem 0 .2rem}
  .labels{display:flex;gap:.4rem;flex-wrap:wrap;margin-bottom:.4rem}.label{font-size:.75rem;padding:.15rem .5rem;border:1px solid var(--chip-border);border-radius:999px;background:var(--bg)}
  .label.journal{border-color:var(--accent-2)}.label.newspaper{border-color:var(--warn)} .oa{font-size:.9em; opacity:.85; margin-left:.4rem}
  .actions{display:flex;gap:.5rem;margin-top:.6rem;flex-wrap:wrap}.btn{background:var(--bg);border:1px solid var(--chip-border);color:var(--text);border-radius:.6rem;padding:.45rem .7rem;font-size:.9rem;cursor:pointer;text-decoration:none;box-shadow:var(--shadow)}.btn:hover{border-color:var(--accent)}
  .small{font-size:.85rem; color:var(--muted)}.tabs{display:flex;gap:.4rem;margin:.6rem 0 1rem}.tab{padding:.45rem .7rem;border:1px solid var(--chip-border);background:var(--bg);border-radius:.6rem;cursor:pointer}.tab.active{border-color:var(--accent)}
  .authors{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:.5rem}.author,.coll{display:flex;justify-content:space-between;gap:.6rem;padding:.5rem .6rem;border:1px solid var(--chip-border);border-radius:.6rem;background:var(--bg);cursor:pointer}
  .alpha{margin-top:1rem;font-weight:600;color:var(--muted)}.pill{display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .5rem;border:1px solid var(--chip-border);border-radius:999px}.pill .x{cursor:pointer;font-weight:700}
  .group{margin:1.2rem 0 .4rem; font-weight:700; color:var(--muted); border-bottom:1px dashed var(--border); padding-bottom:.25rem}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div><div class="title">Bibliographie ‚Äî MatrioscIA</div><div class="sub">GitHub Pages, JSON externe (relatif ou ?data=URL). Cat√©gories = collections Zotero. Sans tri.</div></div>
      <div><button class="btn" id="themeToggle" title="Basculer clair/sombre">‚òÄÔ∏è/üåô</button></div>
    </div>
    <div class="toolbar">
      <input id="q" type="search" placeholder="Rechercher titre, auteur¬∑ice¬∑s‚Ä¶" aria-label="Recherche" />
      <select id="yearFilter"><option value="">Toutes ann√©es</option></select>
      <select id="typeFilter"><option value="">Tous types (Zotero)</option></select>
      <select id="collFilterSel"><option value="">Toutes th√©matiques (collections)</option></select>
    </div>
  </div>
</header>

<div class="wrap">
  <main>
    <aside>
      <div class="panel">
        <h3>Filtres rapides</h3>
        <label class="small"><input type="checkbox" id="hasDOI"/> Avec DOI</label><br/>
        <label class="small"><input type="checkbox" id="hasURL"/> Avec URL</label><br/>
        <div id="activeAuthor" style="margin-top:.6rem; display:none;">
          <span class="pill">Auteur¬∑ice : <strong id="activeAuthorName"></strong> <span class="x" id="clearAuthor" title="Retirer">√ó</span></span>
        </div>
      </div>
      <div class="panel">
        <h3>Export</h3>
        <button class="btn" id="exportJSON">Exporter JSON (filtr√©)</button>
        <button class="btn" id="exportCSV">Exporter CSV (filtr√©)</button>
        <div class="small" style="margin-top:.5rem">Les exports respectent la s√©lection actuelle.</div>
      </div>
      <div class="panel">
        <h3>√Ä propos</h3>
        <div class="small">Collections Zotero ‚Üí th√©matiques. Ic√¥ne üîì si acc√®s ouvert d√©tect√©.</div>
      </div>
    </aside>
    <section>
      <div class="tabs">
        <button class="tab active" data-tab="refs">R√©f√©rences</button>
        <button class="tab" data-tab="authors">Index auteurs</button>
        <button class="tab" data-tab="colls">Index collections</button>
      </div>
      <div id="refsView">
        <div class="count" id="count"></div>
        <div class="list" id="list"></div>
        <div class="empty" id="empty" style="display:none">Aucun r√©sultat. Modifiez les filtres ou la requ√™te.</div>
      </div>
      <div id="authorsView" style="display:none">
        <div style="display:flex; gap:.6rem; align-items:center; margin-bottom:.6rem;">
          <input id="authorSearch" type="search" placeholder="Rechercher dans les auteur¬∑ice¬∑s‚Ä¶" aria-label="Recherche auteurs" />
          <div class="small" id="authorCount"></div>
        </div>
        <div id="authorsList"></div>
      </div>
      <div id="collsView" style="display:none">
        <div style="display:flex; gap:.6rem; align-items:center; margin-bottom:.6rem;">
          <input id="collSearch" type="search" placeholder="Rechercher dans les collections‚Ä¶" aria-label="Recherche collections" />
          <div class="small" id="collCount"></div>
        </div>
        <div id="collsList"></div>
      </div>
    </section>
  </main>
</div>

<script>
(function(){
  // THEME
  const root = document.documentElement;
  function applyTheme(mode){ if(mode==='auto'){ const prefersDark=window.matchMedia('(prefers-color-scheme: dark)').matches; root.setAttribute('data-theme', prefersDark?'dark':'light'); } else { root.setAttribute('data-theme',mode); } }
  function getStoredTheme(){ return localStorage.getItem('theme')||'auto'; }
  function toggleTheme(){ const cur=getStoredTheme(); if(cur==='light') localStorage.setItem('theme','dark'); else if(cur==='dark') localStorage.setItem('theme','light'); else localStorage.setItem('theme','dark'); applyTheme(localStorage.getItem('theme')); }
  applyTheme(getStoredTheme()||'auto'); document.getElementById('themeToggle').addEventListener('click', toggleTheme);

  // Helpers
  const norm=s=>(s||'').toString().toLowerCase().trim();
  const cap=s=>(s||'').toString().trim();
  const uniq=arr=>[...new Set(arr)];
  const hasOpen=url=>/hal\.|openaccess|doi\.org\/10\.|arxiv\.org|zenodo|researchgate/i.test(url||'');
  function hashCode(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return Math.abs(h); }
  function colorFor(name){ const h=hashCode(name)%360; const s=65, l=(document.documentElement.getAttribute('data-theme')==='dark')?40:50; return `hsl(${h} ${s}% ${l}%)`; }
  const NEWS_DOMAINS=/(lemonde\.fr|nytimes\.com|theguardian\.com|lefigaro\.fr|liberation\.fr|washingtonpost\.com|bbc\.com|ft\.com|reuters\.com|apnews\.com)/i;

  // UI refs
  const collSel=document.getElementById('collFilterSel');
  const yearSel=document.getElementById('yearFilter');
  const typeSel=document.getElementById('typeFilter');

  let RAW=null; // original Zotero JSON
  let DATA=[]; // normalized records
  let AUTHOR_FILTER='';

  // Choose data source: ?data=URL or relative MatrioscIA.json
  const params = new URLSearchParams(location.search);
  const dataURL = params.get('data');
  if (dataURL) tryFetch(dataURL);
  else tryFetch(new URL('MatrioscIA.json', location.href).href);

  function log(...a){ try{ console.log('[MatrioscIA]', ...a); }catch(e){} }

  async function tryFetch(url){
    try{
      const r = await fetch(url, {cache: 'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const json = await r.json();
      RAW=json; normalize(); initFacets(); render();
      log('Donn√©es charg√©es depuis:', url);
    }catch(e){
      log('√âchec du chargement :', e.message);
    }
  }

  function creators_to_authors(creators, author_list){
    const names=[];
    if (Array.isArray(creators)){
      for (const c of creators){
        const fn=(c.firstName||c.given||'').trim();
        const ln=(c.lastName||c.family||'').trim();
        if (ln&&fn) names.push(`${ln}, ${fn}`);
        else if (ln) names.push(ln);
        else if (fn) names.push(fn);
      }
    } else if (Array.isArray(author_list)){
      for (const c of author_list){
        const fn=(c.given||'').trim();
        const ln=(c.family||'').trim();
        if (ln&&fn) names.push(`${ln}, ${fn}`);
        else if (ln) names.push(ln);
        else if (fn) names.push(fn);
      }
    }
    return names.join('; ');
  }
  function parse_year(...vals){
    for (const s of vals){
      if (!s) continue;
      if (typeof s==='object' && s['date-parts'] && s['date-parts'][0] && s['date-parts'][0][0]) return String(s['date-parts'][0][0]);
      const m = String(s).match(/\b(1[89]\d{2}|20\d{2}|21\d{2})\b/);
      if (m) return m[0];
    }
    return '';
  }
  function pick_venue(it,obj){
    it=(it||'').toLowerCase();
    if (it==='journalarticle' || it==='newspaperarticle'){
      return obj.publicationTitle || obj.containerTitle || obj.proceedingsTitle || obj.series || '';
    }
    if (it==='conferencepaper'){
      return obj.proceedingsTitle || obj.publicationTitle || obj.containerTitle || '';
    }
    if (it==='webpage'){
      return obj.websiteTitle || obj.publicationTitle || obj.libraryCatalog || '';
    }
    return obj.publicationTitle || obj.containerTitle || obj.websiteTitle || obj.libraryCatalog || '';
  }
  function guess_kind(itemType, venue, url){
    const it=(itemType||'').toLowerCase();
    const v=(venue||'').toLowerCase();
    const u=(url||'').toLowerCase();
    if (it==='journalarticle') return 'journal';
    if (it==='newspaperarticle') return 'newspaper';
    if (NEWS_DOMAINS.test(u)) return 'newspaper';
    if (v.includes('journal') || v.includes('revue')) return 'journal';
    return 'other';
  }

  // Collections mapping ‚Äî supports dict OR array formats
  function build_collections_map(root){
    let nodes = null;
    if (Array.isArray(root.collections)) {
      nodes = {};
      root.collections.forEach(n => {
        const key = n.key || n.id || n.name;
        if (!key) return;
        nodes[key] = {name: n.name || String(key), parent: n.parent || '', items: n.items || [], children: n.collections || []};
      });
    } else if (root.collections && typeof root.collections === 'object') {
      nodes = {};
      Object.entries(root.collections).forEach(([key,meta]) => {
        nodes[key] = {name: meta.name || String(key), parent: meta.parent || '', items: meta.items || [], children: meta.collections || []};
      });
    } else {
      return {}; // no collections
    }

    function full_path(k, seen=new Set()){
      if (seen.has(k)) return nodes[k]?.name || String(k);
      seen.add(k);
      const node = nodes[k] || {};
      const name = node.name || String(k);
      const parentKey = node.parent;
      if (!parentKey) return name;
      return full_path(parentKey, seen) + ' > ' + name;
    }

    const itemToColls = {};
    Object.entries(nodes).forEach(([k,n]) => {
      const path = full_path(k);
      (n.items||[]).forEach(iid => {
        const idStr = String(iid);
        (itemToColls[idStr] ||= []).push(path);
      });
    });
    return itemToColls;
  }

  function normalize(){
    const items = Array.isArray(RAW) ? RAW : (RAW.items||RAW.references||[]);
    const mapItemColls = build_collections_map(Array.isArray(RAW)?{}:RAW);

    DATA = (items||[])
      .filter(it => !['attachment','note'].includes((it.itemType||it.type||'').toLowerCase()))
      .map((it, idx) => {
        const t = it.itemType || it.type || '';
        const title = it.title || '';
        const authors = creators_to_authors(it.creators, it.author);
        const year = parse_year(it.date, it.issued, it.accessDate);
        const volume = it.volume || '';
        const issue = it.issue || it.number || '';
        const pages = it.pages || it.page || '';
        const doi = it.DOI || it.doi || '';
        const url = it.url || it.URL || '';
        const abstract = it.abstractNote || it.abstract || '';
        const venue = pick_venue(t, it);
        const iid = String(it.itemID || it.id || it.key || idx); // fall back to index to keep order
        const colls = mapItemColls[iid] || [];
        const kind = guess_kind(t, venue, url);
        return { title, authors, year, type:t, venue, doi, url, abstract, collections:colls, kind, volume, issue, pages, _order: idx };
      })
      .filter(r => [r.title, r.authors, r.venue, r.doi, r.url].some(Boolean));
  }

  // APA & rendering
  function splitAuthors(raw){ if(!raw) return []; return raw.split(/\s*(?:;|,| and | et |&|‚Ä¢|\|)\s*/i).map(s=>s.trim()).filter(Boolean); }
  function formatNameAPA(name){ name=name.replace(/\s+/g,' ').trim(); if(!name) return ''; let last='', firsts=''; if(name.includes(',')){ const [l,f='']=name.split(',').map(s=>s.trim()); last=l; firsts=f; } else { const parts=name.split(' '); if(parts.length===1){ last=parts[0]; } else { last=parts.pop(); firsts=parts.join(' ');} } const initials=firsts.split(/[-\s]/).filter(Boolean).map(x=>x[0]?.toUpperCase()+'.').join(' '); return last + (initials? ', '+initials : ''); }
  function formatAuthorsAPA(list){ const formatted=list.map(formatNameAPA).filter(Boolean); if(!formatted.length) return ''; if(formatted.length===1) return formatted[0]; if(formatted.length===2) return formatted[0]+' & '+formatted[1]; if(formatted.length<=20) return formatted.slice(0,-1).join(', ')+', & '+formatted.at(-1); return formatted.slice(0,19).join(', ')+', ‚Ä¶, '+formatted.at(-1); }
  function apaCitation(d){ const authors=formatAuthorsAPA(splitAuthors(d.authors)); const year=cap(d.year); const title=cap(d.title); const venue=cap(d.venue); const vol=cap(d.volume); const issue=cap(d.issue); const pages=cap(d.pages); const doi=cap(d.doi); const url=cap(d.url); let parts=[]; if(authors) parts.push(authors); if(year) parts.push(`(${year}).`); if(title) parts.push(`${title}.`); if(d.kind==='journal'){ let after=''; if(venue) after += ` <em>${venue}</em>`; if(vol) after += `, ${vol}`; if(issue) after += `(${issue})`; if(pages) after += `, ${pages}`; if(after) after += '.'; parts.push(after.trim()); } else if(d.kind==='newspaper'){ if(venue) parts.push(`<em>${venue}</em>.`); } else { if(venue) parts.push(`<em>${venue}</em>.`);} if(doi) parts.push(`https://doi.org/${doi}`); else if(url) parts.push(url); return parts.filter(Boolean).join(' ').replace(/\s+/g,' ').trim(); }

  function rowHTML(d){
    const doiLink=d.doi?`<a class="btn" href="https://doi.org/${d.doi}" target="_blank" rel="noopener">DOI</a>`:'';
    const urlLink=d.url?`<a class="btn" href="${d.url}" target="_blank" rel="noopener">Ouvrir</a>`:'';
    const oa = d.url && hasOpen(d.url) ? `<span class="oa" title="Acc√®s ouvert d√©tect√©">üîì</span>` : '';
    const collBadges=(d.collections||[]).map(c=>`<span class="label" style="border-color:${colorFor(c)};">${c}</span>`).join(' ');
    const labels=[`<span class="label ${d.kind}">${d.kind==='journal'?'Journal article':(d.kind==='newspaper'?'Newspaper':'Autre')}</span>`, collBadges, oa].filter(Boolean).join(' ');
    return `<article class="item ${d.kind}"><div class="labels">${labels}</div><h4>${d.title || '(Sans titre)'}</h4><p class="apa">${apaCitation(d)}</p><div class="actions">${doiLink} ${urlLink}<button class="btn" onclick='copyCitation(this)'>Copier (APA)</button></div></article>`;
  }
  window.copyCitation=(btn)=>{ const item=btn.closest('.item'); const apa=item.querySelector('.apa').innerText; navigator.clipboard.writeText(apa); btn.textContent='Copi√© !'; setTimeout(()=>btn.textContent='Copier (APA)',1200); };

  function applyFilters(arr){
    const qv=norm(document.getElementById('q').value);
    const yv=document.getElementById('yearFilter').value;
    const tv=document.getElementById('typeFilter').value;
    const collF=document.getElementById('collFilterSel').value;
    return arr.filter(d=>{
      if (yv && String(d.year)!==String(yv)) return false;
      if (tv && String(d.type)!==String(tv)) return false;
      if (document.getElementById('hasDOI').checked && !d.doi) return false;
      if (document.getElementById('hasURL').checked && !d.url) return false;
      if (AUTHOR_FILTER && !(d.authors||'').toLowerCase().includes(AUTHOR_FILTER.toLowerCase())) return false;
      if (collF && !(d.collections||[]).some(c=> c.toLowerCase()===collF.toLowerCase())) return false;
      if (qv){ const hay=[d.title,d.authors,d.venue,d.year,d.type,d.doi,d.url,...(d.collections||[])].join(' \n ').toLowerCase(); if(!hay.includes(qv)) return false; }
      return true;
    });
  }

  function initFacets(){
    const years=uniq(DATA.map(d=>d.year).filter(Boolean)).sort((a,b)=>String(b).localeCompare(String(a)));
    const types=uniq(DATA.map(d=>d.type).filter(Boolean)).sort((a,b)=>String(a).localeCompare(String(b)));
    const colls=uniq(DATA.flatMap(d=> d.collections||[])).sort((a,b)=> a.localeCompare(b,'fr'));
    years.forEach(y=> yearSel.insertAdjacentHTML('beforeend', `<option value="${y}">${y}</option>`));
    types.forEach(t=> typeSel.insertAdjacentHTML('beforeend', `<option value="${t}">${t}</option>`));
    colls.forEach(c=> collSel.insertAdjacentHTML('beforeend', `<option value="${c}">${c}</option>`));
  }

  function render(){
    let arr=applyFilters(DATA.slice()); // preserve source order
    const listEl=document.getElementById('list');
    listEl.innerHTML = arr.map(rowHTML).join('');
    document.getElementById('count').textContent = `${arr.length} r√©sultat(s) sur ${DATA.length}`;
    document.getElementById('empty').style.display = arr.length ? 'none' : 'block';
  }

  // Tabs
  const tabs=document.querySelectorAll('.tab'); const refsView=document.getElementById('refsView'); const authorsView=document.getElementById('authorsView'); const collsView=document.getElementById('collsView');
  tabs.forEach(t=>t.addEventListener('click',()=>{ tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); refsView.style.display=(t.dataset.tab==='refs')?'block':'none'; authorsView.style.display=(t.dataset.tab==='authors')?'block':'none'; collsView.style.display=(t.dataset.tab==='colls')?'block':'none'; if(t.dataset.tab==='authors') renderAuthors(); if(t.dataset.tab==='colls') renderColls(); }));

  function renderAuthors(){
    const authorsList=document.getElementById('authorsList'); const authorSearch=document.getElementById('authorSearch'); const authorCount=document.getElementById('authorCount');
    const mapCount=new Map();
    DATA.forEach(d=>{ (d.authors||'').split(/\s*(?:;|,| and | et |&|\|)\s*/i).map(s=>s.trim()).filter(Boolean).forEach(a=> mapCount.set(a,(mapCount.get(a)||0)+1) ); });
    let items=[...mapCount.entries()].sort((a,b)=> a[0].localeCompare(b[0],'fr',{sensitivity:'base'}));
    const qA=(authorSearch?.value||'').toLowerCase().trim();
    if (qA) items=items.filter(([name])=> name.toLowerCase().includes(qA));
    authorCount.textContent=`${items.length} auteur¬∑ice(s)`;
    const groups={}; items.forEach(([name,cnt])=>{ const init=(name[0]||'#').toUpperCase(); (groups[init] ||= []).push([name,cnt]); });
    const container=document.createElement('div');
    Object.keys(groups).sort().forEach(init=>{
      const block=document.createElement('div');
      block.innerHTML=`<div class="alpha">${init}</div>`;
      const grid=document.createElement('div');
      grid.className='authors';
      groups[init].forEach(([name,cnt])=>{
        const el=document.createElement('div');
        el.className='author';
        el.innerHTML=`<span class="name">${name}</span><span class="small">${cnt}</span>`;
        el.addEventListener('click',()=>{
          AUTHOR_FILTER=name;
          document.getElementById('activeAuthorName').textContent=name;
          document.getElementById('activeAuthor').style.display='block';
          document.querySelector('.tab[data-tab="refs"]').click();
          render();
        });
        grid.appendChild(el);
      });
      grid.style.marginTop='.4rem';
      block.appendChild(grid);
      container.appendChild(block);
    });
    authorsList.innerHTML='';
    authorsList.appendChild(container);
  }
  document.getElementById('authorSearch')?.addEventListener('input', renderAuthors);

  function renderColls(){
    const collsList=document.getElementById('collsList'); const collSearch=document.getElementById('collSearch'); const collCount=document.getElementById('collCount');
    const mapCount=new Map();
    DATA.forEach(d=> (d.collections||[]).forEach(c=> mapCount.set(c,(mapCount.get(c)||0)+1) ));
    let items=[...mapCount.entries()].sort((a,b)=> a[0].localeCompare(b[0],'fr',{sensitivity:'base'}));
    const qC=(collSearch?.value||'').toLowerCase().trim();
    if (qC) items=items.filter(([name])=> name.toLowerCase().includes(qC));
    collCount.textContent=`${items.length} collection(s)`;
    const groups={}; items.forEach(([name,cnt])=>{ const init=(name[0]||'#').toUpperCase(); (groups[init] ||= []).push([name,cnt]); });
    const container=document.createElement('div');
    Object.keys(groups).sort().forEach(init=>{
      const block=document.createElement('div');
      block.innerHTML=`<div class="alpha">${init}</div>`;
      const grid=document.createElement('div');
      grid.className='authors';
      groups[init].forEach(([name,cnt])=>{
        const el=document.createElement('div');
        el.className='coll';
        el.innerHTML=`<span class="name">${name}</span><span class="small">${cnt}</span>`;
        el.addEventListener('click',()=>{
          collSel.value=name;
          document.querySelector('.tab[data-tab="refs"]').click();
          render();
        });
        grid.appendChild(el);
      });
      grid.style.marginTop='.4rem';
      block.appendChild(grid);
      container.appendChild(block);
    });
    collsList.innerHTML='';
    collsList.appendChild(container);
  }
  document.getElementById('collSearch')?.addEventListener('input', renderColls);

  // Events
  ['q','yearFilter','typeFilter','collFilterSel','hasDOI','hasURL'].forEach(id=> document.getElementById(id).addEventListener('input', render));

  // Exports
  function download(filename, text){ const a=document.createElement('a'); a.setAttribute('href','data:text/plain;charset=utf-8,'+encodeURIComponent(text)); a.setAttribute('download',filename); a.style.display='none'; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
  document.getElementById('exportJSON').onclick=()=>{ const filtered=applyFilters(DATA.slice()); download('bibliographie-filtre.json', JSON.stringify(filtered, null, 2)); };
  document.getElementById('exportCSV').onclick=()=>{ const filtered=applyFilters(DATA.slice()); if(!filtered.length) return download('bibliographie-filtre.csv',''); const keys=Object.keys(filtered[0]||{}); const esc=v=>('"' + String(v).replaceAll('"','""') + '"'); const rows=[keys.map(esc).join(',')].concat(filtered.map(r=> keys.map(k=> esc(r[k] || '')).join(','))); download('bibliographie-filtre.csv', rows.join('\n')); };
})();</script>
</body>
</html>
