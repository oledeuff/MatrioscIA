<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>catalogue d’enquêtes de type OSINT — Investigations audiovisuelles</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .chip{display:inline-flex;align-items:center;gap:.375rem;border-radius:9999px;padding:.125rem .5rem;font-size:.75rem;line-height:1rem;border:1px solid rgba(0,0,0,0.06);}
    .chip-light{background:#f3f4f6;color:#374151;}
    .chip-ia{background:#e0e7ff;color:#1e1b4b;border-color:#c7d2fe;}
    .chip-proactive{background:#059669;color:#fff;}
    .chip-reactive{background:#d97706;color:#fff;}
    .chip-theme{color:#fff;}
    .card{border-left-width:8px;border-radius:1rem;border:1px solid #e5e7eb;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04);}
    .card-title{font-weight:700;font-size:1.05rem;line-height:1.35;}
    .logo-fallback{width:40px;height:40px;border-radius:9999px;background:#e5e7eb;display:flex;align-items:center;justify-content:center;font-weight:800;color:#111827;}
    .grid-auto{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:1rem;}
    @media (min-width:768px){.grid-auto{grid-template-columns:repeat(2,minmax(0,1fr));}}
    @media (min-width:1280px){.grid-auto{grid-template-columns:repeat(3,minmax(0,1fr));}}
    .link-icon{font-size:1.1rem;text-decoration:none}
    .link-icon:focus{outline:2px solid #7c3aed;outline-offset:2px;border-radius:.25rem}
  </style>
  <script src="data_osint.js"></script>
</head>
<body class="bg-white text-gray-900">
  <header class="bg-gradient-to-r from-slate-300 via-gray-400 to-violet-500">
    <div class="max-w-7xl mx-auto px-4 py-6">
      <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">catalogue d’enquêtes de type OSINT</h1>
      <p class="text-sm md:text-base opacity-90">Investigations audiovisuelles</p>
    </div>
  </header>

  <section class="max-w-7xl mx-auto px-4 py-4">
    <div class="flex flex-col md:flex-row md:items-end md:gap-4 gap-3">
      <div class="flex-1">
        <label for="search" class="block text-sm font-medium text-gray-700">Recherche (titre, résumé, commentaire)</label>
        <input id="search" type="search" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2" placeholder="Rechercher…" aria-label="Recherche plein-texte">
      </div>
      <div>
        <label for="mediaFilter" class="block text-sm font-medium text-gray-700">Média</label>
        <select id="mediaFilter" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2" aria-label="Filtre média">
          <option value="">(tous)</option>
        </select>
      </div>
      <div>
        <label for="themeFilter" class="block text-sm font-medium text-gray-700">Thématique</label>
        <select id="themeFilter" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2" aria-label="Filtre thématique">
          <option value="">(toutes)</option>
        </select>
      </div>
      <div>
        <label for="proactFilter" class="block text-sm font-medium text-gray-700">Proactivité</label>
        <select id="proactFilter" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2" aria-label="Filtre proactivité">
          <option value="">(toutes)</option>
          <option value="proactive">proactive</option>
          <option value="reactive">réactive</option>
        </select>
      </div>
      <div>
        <label for="iaFilter" class="block text-sm font-medium text-gray-700">IA</label>
        <select id="iaFilter" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2" aria-label="Filtre IA">
          <option value="">(tout)</option>
          <option value="yes">yes</option>
          <option value="no">no</option>
        </select>
      </div>
    </div>

    <div class="mt-3 flex items-center gap-3">
      <button id="resetBtn" class="rounded-xl bg-gray-100 hover:bg-gray-200 px-3 py-2 text-sm">Réinitialiser</button>
      <button id="exportBtn" class="rounded-xl bg-violet-600 hover:bg-violet-700 text-white px-3 py-2 text-sm">Exporter en CSV</button>
      <div id="counter" class="ml-auto text-sm text-gray-600" aria-live="polite"></div>
    </div>
  </section>

  <main class="max-w-7xl mx-auto px-4 pb-10">
    <div id="grid" class="grid-auto"></div>
  </main>

  <footer class="border-t border-gray-200">
    <div class="max-w-7xl mx-auto px-4 py-6 text-sm text-gray-700">
      Projet MatrioscIA – IHEMI. Olivier Le Deuff, Thais Barbosa de Almeida, Rayya Roumanos, Mailuxa Pagola. 2025. Licence CC BY
    </div>
  </footer>

  <script>
    (function attachCountComment(){
      try{
        const rows = (window.RAW_ROWS && Array.isArray(window.RAW_ROWS) ? window.RAW_ROWS : (window.DATA||[]));
        const comment = document.createComment(' Nombre total de fiches intégrées : ' + rows.length + ' ');
        const s = document.currentScript;
        s.parentNode.insertBefore(comment, s);
      }catch(e){}
    })();

    const latinize = (s='') => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const normSpaces = s => (s||'').replace(/\s+/g,' ').trim();
    const lower = s => latinize(normSpaces(String(s||''))).toLowerCase();
    const isTruthy = v => !(v===null || v===undefined || (typeof v==='string' && v.trim()===''));

    const MEDIA_LOGO_DOMAIN = {"AFP": "afp.com", "Le Monde": "lemonde.fr", "Libération": "liberation.fr", "Le Figaro": "lefigaro.fr", "France 24": "france24.com", "Franceinfo": "francetvinfo.fr", "ARTE": "arte.tv", "BBC": "bbc.co.uk", "The Guardian": "theguardian.com", "The New York Times": "nytimes.com", "Washington Post": "washingtonpost.com", "Reuters": "reuters.com", "AP": "apnews.com", "Financial Times": "ft.com", "WSJ": "wsj.com", "CNN": "cnn.com", "Bloomberg": "bloomberg.com", "Mediapart": "mediapart.fr", "Les Echos": "lesechos.fr", "L'Express": "lexpress.fr", "L'Obs": "nouvelobs.com", "20 Minutes": "20minutes.fr", "Courrier international": "courrierinternational.com", "Radio France": "radiofrance.fr"};
    const MEDIA_ABBR = {"le monde": "LM", "lemonde": "LM", "libération": "LIBÉ", "liberation": "LIBÉ", "le figaro": "LF", "france 24": "F24", "france24": "F24", "franceinfo": "FI", "france info": "FI", "arte": "ARTE", "bfmtv": "BFM", "tf1": "TF1", "lci": "LCI", "mediapart": "MP", "rfi": "RFI", "la croix": "LC", "le parisien": "LP", "les echos": "LE", "l'express": "LEX", "lobs": "OBS", "20 minutes": "20M", "courrier international": "CI", "marianne": "MAR", "the new york times": "NYT", "new york times": "NYT", "nyt": "NYT", "washington post": "WP", "wsj": "WSJ", "financial times": "FT", "the guardian": "TG", "guardian": "TG", "bbc": "BBC", "reuters": "REU", "associated press": "AP", "ap": "AP", "bloomberg": "BBG", "cnn": "CNN", "radio france":"RF"};

    function parseToISO(input){
      if(!isTruthy(input)) return null;
      const s = String(input).trim();
      const mISO = s.match(/^(\d{4})[-\/.](\d{1,2})[-\/.](\d{1,2})$/);
      if(mISO){ const y=+mISO[1], mo=+mISO[2], d=+mISO[3]; if(validYMD(y,mo,d)) return fmtISO(y,mo,d); }
      const mDF = s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})$/);
      if(mDF){ let d=+mDF[1], mo=+mDF[2], y=+mDF[3]; if(y<100) y+=2000; if(validYMD(y,mo,d)) return fmtISO(y,mo,d); }
      const mois = {'janvier':1,'fevrier':2,'février':2,'mars':3,'avril':4,'mai':5,'juin':6,'juillet':7,'aout':8,'août':8,'septembre':9,'octobre':10,'novembre':11,'decembre':12,'décembre':12,
                    'january':1,'february':2,'march':3,'april':4,'may':5,'june':6,'july':7,'august':8,'september':9,'october':10,'november':11,'december':12};
      const mName = s.match(/^(\d{1,2})\s+([A-Za-zéèêëàâîïôöûüç]+)\s+(\d{4})$/i);
      if(mName){ const d=+mName[1], mo = mois[mName[2].toLowerCase()]||0, y=+mName[3]; if(validYMD(y,mo,d)) return fmtISO(y,mo,d); }
      const t = new Date(s);
      if(!isNaN(t)) return fmtISO(t.getFullYear(), t.getMonth()+1, t.getDate());
      return null;
    }
    function validYMD(y,m,d){
      if(y<1900||y>2100||m<1||m>12||d<1||d>31) return false;
      const dt=new Date(y,m-1,d);
      return dt.getFullYear()===y && (dt.getMonth()+1)===m && dt.getDate()===d;
    }
    function fmtISO(y,m,d){
      const pad = n => String(n).padStart(2,'0');
      return y+'-'+pad(m)+'-'+pad(d);
    }
    function formatDateFR(iso){
      if(!iso) return '(date manquante)';
      const [y,m,d] = iso.split('-').map(Number);
      try{
        const dt = new Date(y, m-1, d);
        return new Intl.DateTimeFormat('fr-FR',{dateStyle:'medium'}).format(dt);
      }catch(e){ return '(date manquante)'; }
    }

    function normalizeMedia(s){
      const raw = normSpaces(s||'');
      const l = lower(raw);
      if(l.includes('afp factuel')) return 'AFP';
      if(l.includes('révélateurs') || l.includes('revelateurs')) return 'France Télévisions';
      if(l === 'les observateurs' || l.includes('observateurs')) return 'France 24';
      if(l==='associated press' || l==='ap') return 'Associated Press';
      if(l==='washington post' || l==='the washington post') return 'The Washington Post';
      if(l==='the new york times' || l==='nytimes' || l==='new york times' || l==='nyt') return 'The New York Times';
      if(l==='franceinfo' || l==='france info') return 'Franceinfo';
      if(l==='arte') return 'ARTE';
      return raw || '(sans média)';
    }

    const MEDIA_LOGOS = {
      'AFP':'https://upload.wikimedia.org/wikipedia/commons/thumb/6/66/Agence_France-Presse_logo.svg/320px-Agence_France-Presse_logo.svg.png',
      'France 24':'https://upload.wikimedia.org/wikipedia/commons/5/50/France_24_Logo.svg',
      'Franceinfo':'https://upload.wikimedia.org/wikipedia/commons/8/86/Franceinfo_logo_2016.svg',
      'Le Monde':'https://upload.wikimedia.org/wikipedia/commons/2/2e/Le_Monde_logo_2010.svg',
      'Libération':'https://upload.wikimedia.org/wikipedia/commons/1/1a/Liberation_logo.svg',
      'Le Figaro':'https://upload.wikimedia.org/wikipedia/commons/b/bb/Le_Figaro_logo.svg',
      'Mediapart':'https://upload.wikimedia.org/wikipedia/commons/5/5a/Mediapart_logo.svg',
      'ARTE':'https://upload.wikimedia.org/wikipedia/commons/2/2a/Arte_Logo_2017.svg',
      'Arte':'https://upload.wikimedia.org/wikipedia/commons/2/2a/Arte_Logo_2017.svg',
      'The New York Times':'https://upload.wikimedia.org/wikipedia/commons/5/58/NewYorkTimes.svg',
      'The Washington Post':'https://upload.wikimedia.org/wikipedia/commons/0/0e/Washington_Post_logo_2014.svg',
      'Reuters':'https://upload.wikimedia.org/wikipedia/commons/4/48/Reuters_Logo.svg',
      'BBC':'https://upload.wikimedia.org/wikipedia/commons/1/1a/BBC_Logo_2021.svg',
      'The Guardian':'https://upload.wikimedia.org/wikipedia/commons/8/8c/The_Guardian_2018.svg',
      'Associated Press':'https://upload.wikimedia.org/wikipedia/commons/6/6b/Associated_Press_logo_2012.svg',
      'Bellingcat':'https://upload.wikimedia.org/wikipedia/commons/0/04/Bellingcat-logo.svg',
      'Financial Times':'https://upload.wikimedia.org/wikipedia/commons/5/5a/Financial_Times_corporate_logo_%282020%29.svg',
      'The Wall Street Journal':'https://upload.wikimedia.org/wikipedia/commons/4/40/The_Wall_Street_Journal_Logo.svg',
      'WSJ':'https://upload.wikimedia.org/wikipedia/commons/4/40/The_Wall_Street_Journal_Logo.svg',
      'CNN':'https://upload.wikimedia.org/wikipedia/commons/b/b1/CNN.svg',
      'Bloomberg':'https://upload.wikimedia.org/wikipedia/commons/7/76/Bloomberg_logo.svg',
      'Les Echos':'https://upload.wikimedia.org/wikipedia/commons/2/24/Les_Echos_logo.svg',
      "L'Express":'https://upload.wikimedia.org/wikipedia/commons/3/3f/Logo_L%27Express_2015.svg',
      "L'Obs":'https://upload.wikimedia.org/wikipedia/commons/3/3a/L%27Obs_logo_2014.svg',
      '20 Minutes':'https://upload.wikimedia.org/wikipedia/commons/3/32/Logo_20_Minutes.svg',
      'Courrier international':'https://upload.wikimedia.org/wikipedia/commons/2/2e/Courrier_international_Logo.svg',
      'France Télévisions':'https://upload.wikimedia.org/wikipedia/commons/1/1c/Logo_France_Televisions_2018.svg',
      'Radio France':'https://upload.wikimedia.org/wikipedia/commons/5/51/Radio_France_logo_2017.svg'
    };

    function canonicalThemeKey(s){ return lower(s||''); }
    const THEME_COLORS = new Map([
      ['humanitaire', '#8b5cf6'],
      ['problematiques environnementales', '#10b981'],
      ['problématiques environnementales', '#10b981'],
      ['strategies militaires et influence', '#78866B'],
      ['stratégies militaires et influence', '#78866B'],
      ['crime organise', '#000000'],
      ['crime organisé', '#000000'],
      ["repression de l'etat", '#f97316'],
      ["répression de l'etat", '#f97316'],
      ["repression de l’état", '#f97316'],
      ['approfondissement de l’actualite', '#3b82f6'],
      ["approfondissement de l'actualite", '#3b82f6'],
      ['approfondissement de l’actualité', '#3b82f6'],
      ["approfondissement de l'actualité", '#3b82f6'],
      ['catastrophes naturelles', '#ef4444'],
    ]);
    function colorForTheme(theme){
      const key = canonicalThemeKey(theme);
      let color = THEME_COLORS.get(key);
      if(!color) color = THEME_COLORS.get(lower(theme));
      if(color) return color;
      if(!isTruthy(theme)) return null;
      const hex = hslHashToHex(theme);
      return hex;
    }
    function hslHashToHex(s){
      const h = Math.abs([...lower(s)].reduce((a,c)=>((a<<5)-a + c.charCodeAt(0))|0,0)) % 360;
      const sat = 55, light = 45;
      return hslToHex(h, sat, light);
    }
    function hslToHex(h,s,l){
      s/=100; l/=100;
      const k=n=>(n+(h/30))%12;
      const a=s*Math.min(l,1-l);
      const f=n=>l-a*Math.max(-1,Math.min(k(n)-3,Math.min(9-k(n),1)));
      const toHex=x=>Math.round(255*x).toString(16).padStart(2,'0');
      return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`;
    }

    const REACTIVE_HINTS = /(fact[\s-]?check|factcheck|vrai\s*\/\s*faux|vrai\s*-\s*faux|desinfo|désinfo|désinformation|debunk|intox)/i;
    const PROACTIVE_HINTS = /(enqu(ê|e)te|investigation|osint|cartographi|geolocali|g(é|e)olocali)/i;
    function normalizeProact(v, textForHeuristic){
      const l = lower(v||'');
      if(l==='proactive') return 'proactive';
      if(l==='reactive') return 'reactive';
      if(!isTruthy(v)){
        const t = textForHeuristic || '';
        if(REACTIVE_HINTS.test(t)) return 'reactive';
        if(PROACTIVE_HINTS.test(t)) return 'proactive';
      }
      if(l.includes('proac')) return 'proactive';
      if(l.includes('reac')) return 'reactive';
      return '';
    }

    const IA_PAT = /(intelligence\s*artificielle|(?:\b|_)(ia|i\.a\.|ai|llm|deepfake|apprentissage\s+automatique|deep\s*learning|r(é|e)seau\s*neuronal|mod(è|e)les?\s+de\s+langue|g(é|e)n(é|e)ratif|chatgpt|openai|midjourney|stable\s+diffusion|llama|elevenlabs|suno))(?![a-z])/i;
    function detectHasIA(hasIA, text){
      if(typeof hasIA === 'boolean') return hasIA;
      return IA_PAT.test(text||'');
    }

    function parseAuthors(a){
      if(Array.isArray(a)) return a.filter(isTruthy).map(x=>normSpaces(String(x)));
      if(!isTruthy(a)) return [];
      const s = String(a);
      const parts = s.split(/\s*(?:\||;|,|\/|&| et |“|”|\"|\band\b)\s*/i);
      return parts.map(x=>normSpaces(x)).filter(Boolean);
    }

    function normalizeURL(u){
      if(!isTruthy(u)) return '';
      const s = String(u).trim();
      if(/^https?:\/\//i.test(s)) return s;
      return 'https://' + s.replace(/^\/+/,'');
    }

    const RAW_ROWS = (window.RAW_ROWS && Array.isArray(window.RAW_ROWS)) ? window.RAW_ROWS : (window.DATA || []);

    function normalizeThemeLabel(themeRaw){
      let theme = themeRaw ? normSpaces(themeRaw) : '';
      const k = canonicalThemeKey(theme);
      if(k.includes('strategies militaires') && !k.includes('influence')){
        theme = 'stratégies militaires et influence';
      }
      return theme;
    }

    function mapRow(r){
      const title = r.title ?? r.titre ?? '';
      const content = r.content ?? r.resume ?? r.résumé ?? '';
      const commentaire = r.commentaire ?? r.notes ?? '';
      const dateISO = parseToISO(r.date);
      const media = normalizeMedia(r.media);
      const link = normalizeURL(r.link||r.url||'');
      const authors = parseAuthors(r.authors);
      const theme = normalizeThemeLabel(r.theme || '');
      const textForHeuristic = [title,content,commentaire].join(' ').toLowerCase();
      const proact = normalizeProact(r.proact, textForHeuristic);
      const hasIA = detectHasIA(r.hasIA, [commentaire,title,content].join(' '));
      return { title, content, commentaire, dateISO, media, link, authors, theme, proact, hasIA };
    }
    const rows = RAW_ROWS.map(mapRow);

    function uniqNorm(arr){
      const seen = new Set(); const out=[];
      for(const v of arr){
        const key = lower(v);
        if(!seen.has(key)){ seen.add(key); out.push(v); }
      }
      return out;
    }
    const mediaList = uniqNorm(rows.map(r=>r.media)).sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'}));
    const themeList = (()=>{
      const all = rows.map(r=>r.theme && r.theme.trim() ? r.theme : 'Sans thématique');
      return uniqNorm(all).sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'}));
    })();
    const mediaSel = document.getElementById('mediaFilter');
    const themeSel = document.getElementById('themeFilter');
    for(const m of mediaList){ const o=document.createElement('option'); o.value=m; o.textContent=m; mediaSel.appendChild(o); }
    for(const th of themeList){ const o=document.createElement('option'); o.value=th; o.textContent=th; themeSel.appendChild(o); }

    const grid = document.getElementById('grid');
    const counter = document.getElementById('counter');
    const searchInput = document.getElementById('search');
    const proSel = document.getElementById('proactFilter');
    const iaSel = document.getElementById('iaFilter');

    function buildFaviconURL(media){
      const domain = MEDIA_LOGO_DOMAIN[media];
      if(!domain) return null;
      return `https://www.google.com/s2/favicons?domain=${encodeURIComponent(domain)}&sz=64`;
    }

    function mediaLogo(media){
      const wiki = MEDIA_LOGOS[media];
      if(wiki){
        const img = document.createElement('img');
        img.src = wiki; img.alt = media; img.width=40; img.height=40; img.className='w-10 h-10 object-contain';
        img.onerror=()=>{ img.replaceWith(tryFaviconOrFallback(media)); };
        return img;
      }
      return tryFaviconOrFallback(media);
    }
    function tryFaviconOrFallback(media){
      const fav = buildFaviconURL(media);
      if(fav){
        const img = document.createElement('img');
        img.src = fav; img.alt = media; img.width=40; img.height=40; img.className='w-10 h-10 object-contain rounded';
        img.onerror=()=>{ img.replaceWith(fallbackLogo(media)); };
        return img;
      }
      return fallbackLogo(media);
    }
    function fallbackLogo(media){
      const d = document.createElement('div');
      d.className='logo-fallback'; d.setAttribute('aria-label', media);
      const key = lower(media);
      const abbr = MEDIA_ABBR[key];
      d.textContent = abbr || (media||'?').split(/\s+/).map(x=>x[0]).join('').slice(0,3).toUpperCase();
      return d;
    }

    function chipTheme(theme){
      const isMissing = !theme || theme.toLowerCase()==='sans thématique';
      const color = isMissing ? '#94a3b8' : colorForTheme(theme);
      const c = document.createElement('span');
      c.className='chip chip-theme';
      c.style.backgroundColor = color;
      c.style.borderColor = color;
      c.style.color = isMissing ? '#111827' : '#fff';
      c.textContent = isMissing ? 'Sans thématique' : theme;
      c.title = isMissing ? 'Thématique manquante' : 'Thématique : ' + theme;
      return c;
    }

    function renderCard(r){
      const border = colorForTheme(r.theme) || '#94a3b8';
      const art = document.createElement('article');
      art.className='card p-4'; art.style.borderLeftColor = border;

      const top = document.createElement('div'); top.className='flex items-center gap-3';
      top.appendChild(mediaLogo(r.media));

      const titleBox = document.createElement('div'); titleBox.className='flex-1';
      const title = document.createElement('h3'); title.className='card-title';
      title.textContent = r.title || '(titre manquant)';
      titleBox.appendChild(title);
      top.appendChild(titleBox);

      if(isTruthy(r.link)){
        const a = document.createElement('a');
        a.href = r.link; a.target='_blank'; a.rel='noopener'; a.className='link-icon'; a.setAttribute('aria-label','Ouvrir le lien dans un nouvel onglet');
        a.textContent='🔗';
        top.appendChild(a);
      }
      art.appendChild(top);

      if(isTruthy(r.content)){
        const p = document.createElement('p'); p.className='mt-2 text-sm text-gray-800';
        p.textContent = r.content;
        art.appendChild(p);
      }

      const chips = document.createElement('div'); chips.className='mt-3 flex flex-wrap gap-2 items-center';
      const chipMedia = document.createElement('span'); chipMedia.className='chip chip-light'; chipMedia.textContent=r.media;
      chips.appendChild(chipMedia);

      if(r.hasIA){ const c=document.createElement('span'); c.className='chip chip-ia'; c.textContent='IA'; chips.appendChild(c); }
      if(r.proact){
        const c=document.createElement('span'); c.className='chip ' + (r.proact==='proactive'?'chip-proactive':'chip-reactive');
        c.textContent = (r.proact==='reactive' ? 'réactive' : 'proactive');
        chips.appendChild(c);
      }
      chips.appendChild(chipTheme(r.theme && r.theme.trim()? r.theme : 'Sans thématique'));
      art.appendChild(chips);

      if(r.authors && r.authors.length){
        const row = document.createElement('div'); row.className='mt-3 flex flex-wrap gap-2';
        for(const a of r.authors){
          const s=document.createElement('span'); s.className='chip chip-light'; s.textContent=a; row.appendChild(s);
        }
        art.appendChild(row);
      }

      const bottom = document.createElement('div'); bottom.className='mt-3 flex items-center justify-between text-sm text-gray-600';
      const date = document.createElement('span'); date.textContent = formatDateFR(r.dateISO);
      bottom.appendChild(date);
      art.appendChild(bottom);

      return art;
    }

    function defaultSort(a,b){
      const da = a.dateISO || ''; const db = b.dateISO || '';
      if(da && db){ if(da>db) return -1; if(da<db) return 1; }
      else if(da && !db){ return -1; }
      else if(!da && db){ return 1; }
      return a.title.localeCompare(b.title,'fr',{sensitivity:'base'});
    }

    let current = [];
    function apply(){
      const q = lower(searchInput.value||'');
      const m = mediaSel.value||'';
      const th = themeSel.value||'';
      const pro = proSel.value||'';
      const ia = iaSel.value||'';

      current = rows.filter(r=>{
        if(q){
          const hay = lower([r.title,r.content,r.commentaire].join(' '));
          if(!hay.includes(q)) return false;
        }
        if(m && r.media!==m) return false;
        const themeLabel = r.theme && r.theme.trim() ? r.theme : 'Sans thématique';
        if(th && themeLabel!==th) return false;
        if(pro && r.proact!==pro) return false;
        if(ia==='yes' && !r.hasIA) return false;
        if(ia==='no' && r.hasIA) return false;
        return true;
      }).sort(defaultSort);

      grid.innerHTML='';
      for(const r of current){ grid.appendChild(renderCard(r)); }
      counter.textContent = `${current.length} résultat(s) affiché(s) / ${rows.length}`;
    }

    function toCSV(arr){
      const esc = v => {
        if(v===null||v===undefined) return '';
        const s = String(v).replace(/"/g,'""');
        return `"${s}"`;
      };
      const headers = ['title','content','date','media','link','commentaire','authors','theme','proact','hasIA'];
      const lines = [headers.join(',')];
      for(const r of arr){
        const line = [
          r.title,
          r.content,
          r.dateISO || '',
          r.media,
          r.link || '',
          r.commentaire || '',
          (r.authors||[]).join(' | '),
          r.theme || '',
          r.proact || '',
          String(!!r.hasIA)
        ].map(esc).join(',');
        lines.push(line);
      }
      return lines.join('\r\n');
    }
    function downloadCSV(){
      const csv = toCSV(current);
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'catalogue_osint_filtre.csv';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    }

    for(const el of [searchInput, mediaSel, themeSel, proSel, iaSel]){
      el.addEventListener('input', apply);
      el.addEventListener('change', apply);
    }
    document.getElementById('resetBtn').addEventListener('click', ()=>{
      searchInput.value=''; mediaSel.value=''; themeSel.value=''; proSel.value=''; iaSel.value=''; apply();
      searchInput.focus();
    });
    document.getElementById('exportBtn').addEventListener('click', downloadCSV);

    apply();
  </script>
</body>
</html>
