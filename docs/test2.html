<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>catalogue d‚Äôenqu√™tes de type OSINT</title>
<meta name="color-scheme" content="light only">
<style>
:root{
  --bg:#f7f9fb;--surface:#fff;--muted:#475569;--text:#0f172a;--accent:#16a34a;--border:#e2e8f0;--stripe:#f0fdf4;
  --ai-bg:#eef2ff;--ai-text:#3730a3;--pro-bg:#ecfdf5;--pro-text:#065f46;--rea-bg:#fff7ed;--rea-text:#9a3412
}
*{box-sizing:border-box} html,body{margin:0}
body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial;background:var(--bg);color:var(--text)}
/* ===== Header compact ===== */
header{position:sticky;top:0;z-index:10;background:linear-gradient(120deg,#16a34a,#22c55e,#86efac);border-bottom:1px solid var(--border)}
.header-inner{max-width:1120px;margin:0 auto;padding:8px 12px}
h1{margin:0;font-size:20px;line-height:1.1;color:#052e16}
.subtitle{margin:2px 0 6px;font-size:12px;color:#065f46}
.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:6px}
.filters{display:grid;gap:6px;grid-template-columns:1fr}
@media(min-width:1040px){.filters{grid-template-columns:2fr 1fr 1fr 1fr}}
label{display:block;font-size:10px;color:#475569;margin:0 0 2px}
select,input{width:100%;padding:5px 7px;border-radius:8px;border:1px solid var(--border);background:#fff;color:#0f172a;font-size:12px}
.toolbar{display:flex;gap:6px;align-items:center;margin-top:6px}
.btn{appearance:none;border:1px solid var(--border);background:#fff;color:#0f172a;padding:5px 9px;border-radius:8px;cursor:pointer;font-weight:600;font-size:12px}
.btn:hover{border-color:#16a34a}
.count{font-size:11px;color:#065f46;margin-left:auto}
main{max-width:1120px;margin:0 auto;padding:10px 12px}
.grid{display:grid;gap:10px;grid-template-columns:1fr}
@media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
@media(min-width:1040px){.grid{grid-template-columns:1fr 1fr 1fr}}
.item{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px}
.meta-top{display:flex;align-items:center;justify-content:space-between;gap:8px}
.media{display:flex;align-items:center;gap:6px;color:#334155;font-size:12px}
.logo{width:18px;height:18px;border-radius:4px;border:1px solid var(--border);object-fit:contain;background:#fff}
.logo-fallback{width:18px;height:18px;border-radius:4px;background:#e2e8f0;color:#334155;display:flex;align-items:center;justify-content:center;font:700 9px/18px ui-sans-serif}
.chips{display:flex;gap:4px;flex-wrap:wrap}
.chip{padding:1px 6px;border-radius:999px;border:1px solid #dbeafe;font-size:10px}
.chip.ai{background:var(--ai-bg);color:#3730a3}
.chip.pro{background:var(--pro-bg);color:var(--pro-text);border-color:#bbf7d0}
.chip.rea{background:var(--rea-bg);color:var(--rea-text);border-color:#fed7aa}
.title{margin:0;font-size:15px;line-height:1.25}
.desc{color:#475569;font-size:12px}
.kv{display:flex;gap:6px;flex-wrap:wrap;font-size:11px;color:#334155}
.kv span{background:var(--stripe);padding:2px 6px;border-radius:6px}
.actions{display:flex;gap:6px;margin-top:2px;flex-wrap:wrap}
.linkbtn{display:inline-block;padding:5px 7px;border-radius:8px;border:1px solid var(--border);text-decoration:none;color:#0f172a;font-size:12px}
.linkbtn:hover{border-color:#16a34a}
.helper{font-size:11px;color:#475569;margin-top:2px}
.hidden{display:none}
footer{margin:16px 0 12px;color:#065f46;font-size:12px}
footer .foot{padding:10px;border:1px solid var(--border);border-radius:10px;background:linear-gradient(120deg,#ecfdf5,#f0fdf4)}
</style>
</head>
<body>
<header>
  <div class="header-inner">
    <h1>catalogue d‚Äôenqu√™tes de type OSINT</h1>
    <div class="subtitle">Investigations audiovisuelles</div>
    <div class="card">
      <div class="filters">
        <div><label>Recherche</label><input id="q" placeholder="Titre, r√©sum√©, tags‚Ä¶"/></div>
        <div><label>IA</label>
          <select id="ia">
            <option value="">Indiff√©rent</option>
            <option value="y">Oui</option>
            <option value="n">Non</option>
          </select>
        </div>
        <div><label>Type</label>
          <select id="pro">
            <option value="">Indiff√©rent</option>
            <option value="proactive">Proactive</option>
            <option value="reactive">R√©active</option>
          </select>
        </div>
        <div><label>M√©dia</label><select id="media"></select></div>
      </div>
      <div class="filters" style="grid-template-columns:1fr 1fr 1fr 1fr;margin-top:6px">
        <div><label>Auteur</label><select id="author"></select></div>
        <div><label>Th√©matique</label><select id="thema"></select></div>
        <div><label>Ann√©e</label><select id="year"></select></div>
        <div><label>Tri</label>
          <select id="sort">
            <option value="year_desc">Plus r√©cents</option>
            <option value="year_asc">Plus anciens</option>
            <option value="title_asc">Titre A‚ÜíZ</option>
          </select>
        </div>
      </div>
      <div class="toolbar">
        <button class="btn" id="clear">R√©initialiser</button>
        <span class="count" id="count">0 r√©sultat</span>
      </div>
    </div>
  </div>
</header>

<main>
  <div id="grid" class="grid"></div>
  <div style="display:flex;justify-content:center;margin-top:8px">
    <button id="more" class="btn hidden">Voir plus</button>
  </div>
  <footer>
    <div class="foot">Licence <strong>CC BY</strong>.</div>
  </footer>
</main>

<script>
/* ================== UTILITAIRES ================== */
const $ = sel => document.querySelector(sel);
const slug = s => (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g," ").trim();
const uniq = arr => Array.from(new Set((arr||[]).filter(Boolean)));
const getDomainFromUrl = (u)=>{ try{ return new URL(u).hostname; }catch(e){ return ""; } };
const MEDIA_FALLBACK = {
  "bellingcat":"bellingcat.com",
  "le monde":"lemonde.fr",
  "france 24 observers":"observers.france24.com",
  "arte":"arte.tv","bbc":"bbc.co.uk","liberation":"liberation.fr","the guardian":"theguardian.com"
};
function mediaLogoHTML(mediaName, url){
  const name = (mediaName||"").trim();
  const domain = getDomainFromUrl(url) || MEDIA_FALLBACK[slug(name)] || "";
  const initials = (name||domain||"?").split(/\s+/).map(w=>w[0]).join("").slice(0,3).toUpperCase();
  if(!domain){ return `<div class="logo-fallback" title="${name}">${initials||"?"}</div>`; }
  const favicon = `https://www.google.com/s2/favicons?domain=${encodeURIComponent(domain)}&sz=64`;
  return `<img class="logo" src="${favicon}" alt="${name||domain}" onerror="this.replaceWith(Object.assign(document.createElement('div'),{className:'logo-fallback',textContent:'${initials}'}))">`;
}

/* ================== √âTAT ================== */
let ALL = [];
let FILTERED = [];
let PAGE = 1;
const PAGE_SIZE = 12;

/* ================== RENDU ================== */
function itemHTML(d){
  const ai = d.uses_ai===true || String(d.uses_ai).toLowerCase()==="true" || String(d.uses_ai).toLowerCase()==="yes";
  const t = (d.type||"").toLowerCase();
  const type = t.includes("pro") ? "proactive" : (t.includes("rea") ? "reactive" : "");
  const authors = Array.isArray(d.authors) ? d.authors : (d.authors? String(d.authors).split(/[,;|]/) : []);
  const tags = Array.isArray(d.tags) ? d.tags : (d.tags? String(d.tags).split(/[,;|]/):[]);
  const themas = Array.isArray(d.thematic) ? d.thematic : (d.thematic? String(d.thematic).split(/[,;|]/):[]);
  const media = d.media || "";
  const url = d.url || d.link || d.href || "";
  const year = d.year || (d.date? String(d.date).slice(0,4) : "");
  return `
  <article class="item">
    <div class="meta-top">
      <div class="media">
        ${mediaLogoHTML(media,url)}
        <span>${media||"‚Äî"}</span>
      </div>
      <div class="chips">
        ${ai?'<span class="chip ai">IA</span>':''}
        ${type==='proactive'?'<span class="chip pro">Proactive</span>':''}
        ${type==='reactive'?'<span class="chip rea">R√©active</span>':''}
      </div>
    </div>
    <h3 class="title">${d.title||"Sans titre"}</h3>
    <p class="desc">${d.summary||d.description||""}</p>
    <div class="kv">
      ${year?`<span>üóì ${year}</span>`:""}
      ${authors.length?`<span>‚úçÔ∏è ${uniq(authors).join(", ")}</span>`:""}
      ${themas.length?`<span>üè∑ ${uniq(themas).join(", ")}</span>`:""}
      ${tags.length?`<span># ${uniq(tags).join(", ")}</span>`:""}
    </div>
    <div class="actions">
      ${url?`<a class="linkbtn" target="_blank" rel="noopener" href="${url}">Ouvrir la fiche/source</a>`:""}
    </div>
  </article>`;
}

function render(reset=false){
  const grid = $("#grid");
  if(reset){ grid.innerHTML=""; PAGE=1; }
  const end = PAGE*PAGE_SIZE;
  grid.innerHTML = FILTERED.slice(0,end).map(itemHTML).join("");
  $("#count").textContent = `${FILTERED.length} r√©sultat${FILTERED.length>1?'s':''}`;
  $("#more").classList.toggle("hidden", end >= FILTERED.length);
}

/* ================== FILTRES ================== */
function applyFilters(){
  const q = slug($("#q").value);
  const ia = $("#ia").value;
  const pro = $("#pro").value;
  const media = $("#media").value;
  const author = $("#author").value;
  const thema = $("#thema").value;
  const year = $("#year").value;
  const sort = $("#sort").value;

  FILTERED = ALL.filter(d=>{
    const hay = slug([
      d.title,d.summary,d.description,d.media,d.type,
      Array.isArray(d.tags)?d.tags.join(" "):d.tags,
      Array.isArray(d.thematic)?d.thematic.join(" "):d.thematic,
      Array.isArray(d.authors)?d.authors.join(" "):d.authors
    ].filter(Boolean).join(" "));
    if(q && !hay.includes(q)) return false;

    const uses = (d.uses_ai===true || String(d.uses_ai).toLowerCase()==="true" || String(d.uses_ai).toLowerCase()==="yes");
    if(ia==="y" && !uses) return false;
    if(ia==="n" && uses) return false;

    const t = (d.type||"").toLowerCase();
    if(pro==="proactive" && !t.includes("pro")) return false;
    if(pro==="reactive" && !t.includes("rea")) return false;

    if(media && slug(d.media||"")!==media) return false;

    const auths = Array.isArray(d.authors)? d.authors.map(a=>slug(a)) : (d.authors? [slug(d.authors)] : []);
    if(author && !auths.includes(author)) return false;

    // ----- filtre th√©matique -----
    const themas = Array.isArray(d.thematic) ? d.thematic
                  : (d.thematic? String(d.thematic).split(/[,;|]/) : []);
    const themasSlug = themas.map(x=>slug(x));
    if(thema && !themasSlug.includes(thema)) return false;

    if(year){
      const y = (d.year ? String(d.year) : (d.date? String(d.date).slice(0,4) : ""));
      if(String(y)!==String(year)) return false;
    }
    return true;
  });

  if(sort==="year_desc"){
    FILTERED.sort((a,b)=> String(b.year||b.date||"").localeCompare(String(a.year||a.date||"")));
  }else if(sort==="year_asc"){
    FILTERED.sort((a,b)=> String(a.year||a.date||"").localeCompare(String(b.year||b.date||"")));
  }else if(sort==="title_asc"){
    FILTERED.sort((a,b)=> slug(a.title||"").localeCompare(slug(b.title||"")));
  }

  render(true);
}

function rebuildOptions(data){
  // m√©dias
  const medias = uniq(data.map(d=>d.media).filter(Boolean)).sort((a,b)=>slug(a).localeCompare(slug(b)));
  $("#media").innerHTML = ['<option value="">Tous m√©dias</option>']
    .concat(medias.map(m=>`<option value="${slug(m)}">${m}</option>`)).join("");

  // auteurs (d√©dupliqu√©s)
  const authors = uniq(data.flatMap(d=>{
    if(Array.isArray(d.authors)) return d.authors;
    if(d.authors) return String(d.authors).split(/[,;|]/);
    return [];
  }).map(a=>a.trim()).filter(Boolean)).sort((a,b)=>slug(a).localeCompare(slug(b)));
  $("#author").innerHTML = ['<option value="">Tous auteurs</option>']
    .concat(authors.map(a=>`<option value="${slug(a)}">${a}</option>`)).join("");

  // th√©matiques (d√©dupliqu√©es)
  const themas = uniq(data.flatMap(d=>{
    if(Array.isArray(d.thematic)) return d.thematic;
    if(d.thematic) return String(d.thematic).split(/[,;|]/);
    if(Array.isArray(d.thematique)) return d.thematique; // au cas o√π le champ existe
    if(d.thematique) return String(d.thematique).split(/[,;|]/);
    return [];
  }).map(t=>t.trim()).filter(Boolean)).sort((a,b)=>slug(a).localeCompare(slug(b)));
  $("#thema").innerHTML = ['<option value="">Toutes th√©matiques</option>']
    .concat(themas.map(t=>`<option value="${slug(t)}">${t}</option>`)).join("");

  // ann√©es
  const years = uniq(data.map(d=>{
    if(d.year) return String(d.year);
    if(d.date) return String(d.date).slice(0,4);
    return null;
  })).filter(Boolean).sort((a,b)=>Number(b)-Number(a));
  $("#year").innerHTML = ['<option value="">Toutes ann√©es</option>']
    .concat(years.map(y=>`<option value="${y}">${y}</option>`)).join("");
}

/* ================== CHARGEMENT DES DONN√âES ================== */
async function loadData(){
  const res = await fetch("data_osint.json",{cache:"no-store"});
  if(!res.ok) throw new Error("Impossible de charger data_osint.json");
  const json = await res.json();
  return Array.isArray(json)? json : (json.data || []);
}

/* ================== INIT ================== */
async function init(){
  try{
    let data = await loadData();
    // normalisation
    ALL = data.map(d=>({
      title: d.title || d.titre || "",
      summary: d.summary || d.resume || d.description || "",
      media: d.media || d.source || "",
      authors: Array.isArray(d.authors)? d.authors
             : (d.auteurs? String(d.auteurs).split(/[,;|]/).map(s=>s.trim())
             : (d.author? [String(d.author)] : [])),
      year: d.year || (d.date? String(d.date).slice(0,4) : ""),
      type: d.type || d.typologie || "",
      uses_ai: ("uses_ai" in d)? d.uses_ai : (("ia" in d)? d.ia : false),
      tags: d.tags || d.mots_cles || [],
      thematic: d.thematic || d.thematique || [],
      url: d.url || d.link || d.href || ""
    }));

    rebuildOptions(ALL);

    // Affiche 12 fiches imm√©diatement
    FILTERED = ALL.slice();
    $("#sort").value = "year_desc";
    applyFilters();

    $("#more").addEventListener("click", ()=>{ PAGE+=1; render(false); });
  }catch(e){
    $("#grid").innerHTML = `<div class="item"><strong>Erreur :</strong> ${e.message}. Place <code>data_osint.json</code> dans le m√™me dossier que ce fichier.</div>`;
  }
}

document.addEventListener("DOMContentLoaded", ()=>{
  init();
  ["q","ia","pro","media","author","thema","year","sort"].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener("input", applyFilters);
    el.addEventListener("change", applyFilters);
  });
  $("#clear").addEventListener("click", ()=>{
    ["q","ia","pro","media","author","thema","year"].forEach(id=>document.getElementById(id).value="");
    $("#sort").value="year_desc";
    applyFilters();
  });
});
</script>
</body>
</html>
